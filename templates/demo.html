<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Forcing Video Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            min-height: 100vh;
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
                max-width: 800px;
            }
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .side-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.1rem;
        }

        .device-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .device-info .device-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            {% if device_type == 'mps' %}
            background: linear-gradient(45deg, #ff9a56, #ffad56);
            {% else %}
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            {% endif %}
        }

        .video-preview {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 30px;
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-display {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }

        .video-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 40px;
        }

        .video-placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .video-controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            transition: width 0.3s ease;
            width: 0%;
        }

        .frame-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prompt-container {
            position: relative;
            margin-bottom: 20px;
        }

        .prompt-input {
            width: 100%;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .prompt-input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .prompt-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .quick-prompts {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-prompt-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            color: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .quick-prompt-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #4ecdc4;
            transform: translateY(-2px);
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .collapsible-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .section-content {
            padding: 20px;
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .input-field {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .slider-container {
            position: relative;
            margin: 10px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4ecdc4;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4ecdc4;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4ecdc4;
        }

        .checkbox-item input[type="checkbox"]:disabled {
            opacity: 0.5;
        }

        .checkbox-label {
            flex: 1;
            font-weight: 500;
        }

        .disabled-note {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .gallery-section {
            margin-top: 30px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .gallery-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: #4ecdc4;
        }

        .gallery-thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.1);
        }

        .gallery-info {
            padding: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #4ecdc4;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #ff6b6b;
        }

        .toast.success {
            border-left-color: #4ecdc4;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4ecdc4;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .generation-stats {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .eta-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4ecdc4;
            text-align: center;
            margin-bottom: 10px;
        }

        .block-progress {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .block-indicator {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .block-indicator.completed {
            background: #4ecdc4;
        }

        .block-indicator.current {
            background: linear-gradient(90deg, #4ecdc4, #ff6b6b);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .hide { display: none !important; }
        .show { display: block !important; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Main Panel -->
        <div class="main-panel">
            <div class="header">
                <h1><i class="fas fa-video"></i> Self-Forcing</h1>
                <p class="subtitle">AI Video Generation with Real-time Preview</p>
            </div>

            <div class="device-info">
                <div class="device-badge">
                    {% if device_type == 'mps' %}
                    <i class="fab fa-apple"></i> Apple Silicon MPS
                    {% else %}
                    <i class="fas fa-microchip"></i> NVIDIA CUDA
                    {% endif %}
                </div>
                <div id="connectionStatus" style="margin-top: 10px; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                    <i class="fas fa-circle" id="connectionIndicator" style="color: #ff6b6b;"></i>
                    <span id="connectionText">Connecting...</span>
                </div>
            </div>

            <!-- Video Preview -->
            <div class="video-preview">
                <div class="video-container">
                    <div class="video-placeholder" id="videoPlaceholder">
                        <i class="fas fa-play-circle"></i>
                        <h3>Video Preview</h3>
                        <p>Your generated video will appear here</p>
                    </div>
                    <canvas id="videoDisplay" class="video-display hide"></canvas>
                </div>
                <div class="video-controls hide" id="videoControls">
                    <button class="control-btn" id="playBtn" onclick="togglePlayback()">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" id="resetBtn" onclick="resetPlayback()">
                        <i class="fas fa-refresh"></i>
                    </button>
                    <button class="control-btn" onclick="downloadVideo()">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>

            <!-- Progress Information -->
            <div class="progress-container">
                <div class="progress-info">
                    <span id="progressText">Ready to generate</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- Generation Statistics -->
            <div class="generation-stats hide" id="generationStats">
                <div class="eta-display" id="etaDisplay">Estimating time remaining...</div>
                <div class="block-progress" id="blockProgress"></div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="framesGenerated">0</div>
                        <div class="stat-label">Frames</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentBlock">0</div>
                        <div class="stat-label">Block</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="elapsedTime">0s</div>
                        <div class="stat-label">Elapsed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="averageBlockTime">0s</div>
                        <div class="stat-label">Avg Block</div>
                    </div>
                </div>
            </div>

            <!-- Frame Information -->
            <div class="frame-info">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="bufferSize">0</div>
                        <div class="stat-label">Buffer</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="playbackSpeed">1x</div>
                        <div class="stat-label">Speed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="displayedFrames">0</div>
                        <div class="stat-label">Displayed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="frameRate">6</div>
                        <div class="stat-label">Target FPS</div>
                    </div>
                </div>
            </div>

            <!-- Video Gallery -->
            <div class="gallery-section">
                <div class="section-title">
                    <i class="fas fa-images"></i> Generated Videos
                </div>
                <div class="gallery-grid" id="videoGallery">
                    <!-- Generated videos will appear here -->
                </div>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="side-panel">
            <!-- Input Section -->
            <div class="input-section">
                <div class="section-title">
                    <i class="fas fa-edit"></i> Prompt
                </div>
                <div class="prompt-container">
                    <textarea 
                        id="prompt" 
                        class="prompt-input" 
                        placeholder="Describe the video you want to generate in detail. The more descriptive, the better the results!"
                        maxlength="1000"
                    ></textarea>
                </div>
                
                <div class="quick-prompts">
                    <button class="quick-prompt-btn" onclick="setQuickPrompt(0)">
                        A stylish woman walks down a Tokyo street filled with warm glowing neon and animated city signage. She wears a black leather jacket, a long red dress, and black boots, and carries a black purse.
                    </button>
                    <button class="quick-prompt-btn" onclick="setQuickPrompt(1)">
                        A white and orange tabby cat is seen happily darting through a dense garden, chasing something with wide, happy eyes as it jogs forward through the narrow path between plants.
                    </button>
                </div>
            </div>

            <!-- Settings Sections -->
            <div class="settings-section">
                <!-- Basic Settings -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('basicSettings')">
                        <span><i class="fas fa-sliders-h"></i> Basic Settings</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content active" id="basicSettings">
                        <div class="control-group">
                            <label for="seed">Seed (use -1 for random):</label>
                            <input type="number" id="seed" class="input-field" value="-1" min="-1" max="999999">
                        </div>
                        
                        <div class="control-group">
                            <label for="fps">Target FPS: <span id="fpsValue">6</span></label>
                            <div class="slider-container">
                                <input type="range" id="fps" class="slider" min="2" max="16" value="6" step="0.5">
                            </div>
                        </div>

                        <div class="control-group">
                            <label for="speed">Playback Speed: <span id="speedValue">1x</span></label>
                            <div class="slider-container">
                                <input type="range" id="speed" class="slider" min="0.5" max="3" value="1" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('advancedSettings')">
                        <span><i class="fas fa-cogs"></i> Advanced Settings</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content" id="advancedSettings">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="torchCompile" {% if device_type == 'mps' %}disabled{% endif %}>
                                <div class="checkbox-label">
                                    <div><i class="fas fa-fire"></i> torch.compile</div>
                                    {% if device_type == 'mps' %}
                                    <div class="disabled-note">Not supported on MPS</div>
                                    {% else %}
                                    <div class="disabled-note">Faster inference after compilation</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="checkbox-item">
                                <input type="checkbox" id="fp8Toggle" {% if device_type == 'mps' %}disabled{% endif %}>
                                <div class="checkbox-label">
                                    <div><i class="fas fa-bolt"></i> FP8 Quantization</div>
                                    {% if device_type == 'mps' %}
                                    <div class="disabled-note">Not supported on MPS</div>
                                    {% else %}
                                    <div class="disabled-note">Reduces memory usage</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="checkbox-item">
                                <input type="checkbox" id="taehvToggle">
                                <div class="checkbox-label">
                                    <div><i class="fas fa-magic"></i> TAEHV VAE</div>
                                    <div class="disabled-note">Higher quality, slower decoding</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Monitor -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('performanceMonitor')">
                        <span><i class="fas fa-tachometer-alt"></i> Performance</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="section-content" id="performanceMonitor">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="memoryUsage">0 GB</div>
                                <div class="stat-label">{% if device_type == 'mps' %}RAM Available{% else %}VRAM Free{% endif %}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="generationRate">0</div>
                                <div class="stat-label">Frames/min</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" id="startBtn" onclick="startGeneration()">
                    <i class="fas fa-play"></i> Generate
                </button>
                <button class="btn btn-secondary" id="stopBtn" onclick="stopGeneration()" style="display: none;">
                    <i class="fas fa-stop"></i> Stop
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <script>
        // Global variables
        const socket = io({
            timeout: 60000,        // 60 second timeout
            transports: ['websocket', 'polling'],  // Try both transports
            upgrade: true,         // Allow transport upgrades
            rememberUpgrade: true, // Remember successful upgrades
            pingTimeout: 30000,    // 30 second ping timeout
            pingInterval: 10000    // 10 second ping interval
        });
        let frameBuffer = [];
        let currentFrameIndex = 0;
        let isPlaying = false;
        let playbackInterval = null;
        let startTime = null;
        let receiveCount = 0;
        let generationActive = false;
        let blockStartTimes = [];
        let blockCompletionTimes = [];

        // Quick prompts
        const quickPrompts = [
            "A stylish woman walks down a Tokyo street filled with warm glowing neon and animated city signage. She wears a black leather jacket, a long red dress, and black boots, and carries a black purse. She walks confidently and casually. The street is damp and reflective, creating a mirror effect of the colorful lights. Many pedestrians walk about.",
            "A white and orange tabby cat is seen happily darting through a dense garden, as if chasing something. Its eyes are wide and happy as it jogs forward, scanning the branches, flowers, and leaves as it walks. The path is narrow as it makes its way between all the plants. the scene is captured from a ground-level angle, following the cat closely, giving a low and intimate perspective. The image is cinematic with warm tones and a grainy texture. The scattered daylight between the leaves and plants above creates a warm contrast, accentuating the cat's orange fur. The shot is clear and sharp, with a shallow depth of field."
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeSliders();
            initializeVideoGallery();
            updatePerformanceStats();
            setInterval(updatePerformanceStats, 5000); // Update every 5 seconds
        });

        function initializeSliders() {
            const fpsSlider = document.getElementById('fps');
            const speedSlider = document.getElementById('speed');
            
            fpsSlider.addEventListener('input', function() {
                document.getElementById('fpsValue').textContent = this.value;
                document.getElementById('frameRate').textContent = this.value;
            });
            
            speedSlider.addEventListener('input', function() {
                document.getElementById('speedValue').textContent = this.value + 'x';
                document.getElementById('playbackSpeed').textContent = this.value + 'x';
                updatePlaybackTiming();
            });
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('i:last-child');
            
            content.classList.toggle('active');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        }

        function setQuickPrompt(index) {
            document.getElementById('prompt').value = quickPrompts[index];
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateProgressBar(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
            document.getElementById('progressText').textContent = text;
        }

        function updateGenerationStats(blockNum, totalBlocks) {
            document.getElementById('currentBlock').textContent = `${blockNum}/${totalBlocks}`;
            
            // Update block progress indicators
            const blockProgress = document.getElementById('blockProgress');
            blockProgress.innerHTML = '';
            
            for (let i = 1; i <= totalBlocks; i++) {
                const indicator = document.createElement('div');
                indicator.className = 'block-indicator';
                
                if (i < blockNum) {
                    indicator.classList.add('completed');
                } else if (i === blockNum) {
                    indicator.classList.add('current');
                }
                
                blockProgress.appendChild(indicator);
            }

            // Calculate ETA
            if (blockCompletionTimes.length > 0) {
                const avgBlockTime = blockCompletionTimes.reduce((a, b) => a + b, 0) / blockCompletionTimes.length;
                const remainingBlocks = totalBlocks - blockNum + 1;
                const etaSeconds = avgBlockTime * remainingBlocks;
                
                const etaMinutes = Math.floor(etaSeconds / 60);
                const etaSecondsRemainder = Math.floor(etaSeconds % 60);
                
                document.getElementById('etaDisplay').textContent = 
                    `ETA: ${etaMinutes}m ${etaSecondsRemainder}s`;
            }

            // Update average block time
            if (blockCompletionTimes.length > 0) {
                const avgTime = blockCompletionTimes.reduce((a, b) => a + b, 0) / blockCompletionTimes.length;
                document.getElementById('averageBlockTime').textContent = Math.round(avgTime) + 's';
            }
        }

        function updateElapsedTime() {
            if (startTime) {
                const elapsed = (Date.now() - startTime) / 1000;
                const minutes = Math.floor(elapsed / 60);
                const seconds = Math.floor(elapsed % 60);
                document.getElementById('elapsedTime').textContent = `${minutes}m ${seconds}s`;
            }
        }

        function updatePerformanceStats() {
            // Update generation rate
            const generationRate = receiveCount > 0 ? Math.round((receiveCount * 60) / ((Date.now() - startTime) / 1000)) : 0;
            document.getElementById('generationRate').textContent = generationRate;
            
            // Fetch memory information from API
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const memoryElement = document.getElementById('memoryUsage');
                    if (memoryElement) {
                        memoryElement.textContent = data.free_memory_gb ? data.free_memory_gb.toFixed(1) + ' GB' : '0 GB';
                    }
                })
                .catch(error => {
                    console.log('Failed to fetch memory stats:', error);
                });
        }

        function updatePlaybackTiming() {
            if (!isPlaying) return;
            
            const fps = parseFloat(document.getElementById('fps').value);
            const speed = parseFloat(document.getElementById('speed').value);
            const interval = (1000 / fps) / speed;
            
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = setInterval(nextFrame, interval);
            }
        }

        function nextFrame() {
            if (frameBuffer.length === 0) return;
            
            const canvas = document.getElementById('videoDisplay');
            const ctx = canvas.getContext('2d');
            
            if (currentFrameIndex >= frameBuffer.length) {
                currentFrameIndex = 0; // Loop
            }
            
            const frame = frameBuffer[currentFrameIndex];
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = 'data:image/jpeg;base64,' + frame.data;
            
            currentFrameIndex++;
            document.getElementById('displayedFrames').textContent = currentFrameIndex;
        }

        function togglePlayback() {
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (frameBuffer.length === 0) return;
            
            isPlaying = true;
            document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>';
            
            const fps = parseFloat(document.getElementById('fps').value);
            const speed = parseFloat(document.getElementById('speed').value);
            const interval = (1000 / fps) / speed;
            
            playbackInterval = setInterval(nextFrame, interval);
            showToast('Playback started', 'success');
        }

        function stopPlayback() {
            isPlaying = false;
            document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>';
            
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
            }
        }

        function resetPlayback() {
            stopPlayback();
            currentFrameIndex = 0;
            frameBuffer = [];
            document.getElementById('displayedFrames').textContent = '0';
            document.getElementById('bufferSize').textContent = '0';
            
            // Hide video display
            document.getElementById('videoDisplay').classList.add('hide');
            document.getElementById('videoPlaceholder').classList.remove('hide');
            document.getElementById('videoControls').classList.add('hide');
            
            showToast('Playback reset', 'info');
        }

        function downloadVideo() {
            // This would trigger a download of the generated MP4
            showToast('Video download started', 'success');
        }

        function enableControls(enable) {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (enable) {
                startBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
                startBtn.disabled = false;
            } else {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'flex';
            }
        }

        function startGeneration() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                showToast('Please enter a prompt', 'error');
                return;
            }

            const seed = parseInt(document.getElementById('seed').value) || -1;
            const enableTorchCompile = document.getElementById('torchCompile').checked;
            const enableFp8 = document.getElementById('fp8Toggle').checked;
            const useTaehv = document.getElementById('taehvToggle').checked;

            // Reset state
            resetPlayback();
            receiveCount = 0;
            blockStartTimes = [];
            blockCompletionTimes = [];
            generationActive = true;

            enableControls(false);
            startTime = Date.now();
            
            // Show generation stats
            document.getElementById('generationStats').classList.remove('hide');
            
            // Start elapsed time counter
            const timeInterval = setInterval(function() {
                updateElapsedTime();
                if (!generationActive) {
                    clearInterval(timeInterval);
                }
            }, 1000);

            socket.emit('start_generation', {
                prompt: prompt,
                seed: seed,
                enable_torch_compile: enableTorchCompile,
                enable_fp8: enableFp8,
                use_taehv: useTaehv
            });

            showToast('Generation started', 'success');
        }

        function stopGeneration() {
            socket.emit('stop_generation');
            enableControls(true);
            generationActive = false;
            document.getElementById('generationStats').classList.add('hide');
            showToast('Generation stopped', 'info');
        }

        function initializeVideoGallery() {
            // This would load previously generated videos
            // For now, just show placeholder
        }

        // Update connection status indicator
        function updateConnectionStatus(connected, text) {
            const indicator = document.getElementById('connectionIndicator');
            const statusText = document.getElementById('connectionText');
            
            if (connected) {
                indicator.style.color = '#4ecdc4';
                statusText.textContent = text || 'Connected';
            } else {
                indicator.style.color = '#ff6b6b';
                statusText.textContent = text || 'Disconnected';
            }
        }
        
        // Socket event handlers
        socket.on('connect', function() {
            console.log('🔗 Connected to server');
            updateConnectionStatus(true, 'Connected');
            showToast('Connected to server', 'success');
        });
        
        socket.on('test_connection', function(data) {
            console.log('✅ SocketIO test successful:', data.message);
        });

        socket.on('disconnect', function() {
            console.log('🔴 Disconnected from server');
            updateConnectionStatus(false, 'Reconnecting...');
            showToast('Disconnected from server, attempting reconnect', 'error');
        });
        
        socket.on('reconnect', function() {
            console.log('🔗 Reconnected to server');
            updateConnectionStatus(true, 'Reconnected');
            showToast('Reconnected to server', 'success');
        });
        
        socket.on('reconnect_attempt', function(attemptNumber) {
            console.log('🔄 Reconnection attempt:', attemptNumber);
            updateConnectionStatus(false, `Reconnecting... (${attemptNumber})`);
        });
        
        socket.on('connect_error', function(error) {
            console.error('🚫 Connection error:', error);
            updateConnectionStatus(false, 'Connection Error');
            showToast('Connection error: ' + error, 'error');
        });

        socket.on('progress', function(data) {
            console.log('📈 Progress update:', data.percent, data.message);
            updateProgressBar(data.percent, data.message);
            
            // Parse block information from message
            const blockMatch = data.message.match(/block (\d+)\/(\d+)/i);
            if (blockMatch) {
                const currentBlock = parseInt(blockMatch[1]);
                const totalBlocks = parseInt(blockMatch[2]);
                console.log('🟠 Block progress:', currentBlock, '/', totalBlocks);
                updateGenerationStats(currentBlock, totalBlocks);
                
                // Track block completion times for ETA
                if (currentBlock > blockCompletionTimes.length) {
                    const now = Date.now();
                    if (blockStartTimes.length > 0) {
                        const blockTime = (now - blockStartTimes[blockStartTimes.length - 1]) / 1000;
                        blockCompletionTimes.push(blockTime);
                        console.log('⏱️ Block', currentBlock - 1, 'completed in', blockTime.toFixed(1), 's');
                    }
                    blockStartTimes.push(now);
                }
            }
        });

        socket.on('frame_ready', function(data) {
            console.log('📡 Received frame:', data.frame_index, 'from block:', data.block_index + 1);
            
            frameBuffer.push(data);
            receiveCount++;
            
            // Update UI counters
            document.getElementById('framesGenerated').textContent = receiveCount;
            document.getElementById('bufferSize').textContent = frameBuffer.length;
            
            // Show video display on first frame
            if (frameBuffer.length === 1) {
                console.log('🎬 Showing video display');
                document.getElementById('videoDisplay').classList.remove('hide');
                document.getElementById('videoPlaceholder').classList.add('hide');
                document.getElementById('videoControls').classList.remove('hide');
            }
            
            // Auto-start playback when we have some frames
            if (frameBuffer.length === 3 && !isPlaying) {
                console.log('▶️ Auto-starting playback');
                startPlayback();
            }
            
            // Update performance stats
            updatePerformanceStats();
        });

        socket.on('generation_complete', function(data) {
            enableControls(true);
            generationActive = false;
            document.getElementById('generationStats').classList.add('hide');
            
            updateProgressBar(100, 'Generation complete!');
            showToast(`Generation completed! ${data.total_frames} frames in ${data.generation_time}`, 'success');
            
            // Add to video gallery (placeholder)
            // addToVideoGallery(data);
        });

        socket.on('error', function(data) {
            enableControls(true);
            generationActive = false;
            document.getElementById('generationStats').classList.add('hide');
            showToast(`Error: ${data.message}`, 'error');
        });
    </script>
</body>
</html>